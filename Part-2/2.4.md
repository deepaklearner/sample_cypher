Thanks for clarifying ‚Äî so:

* **Source of truth**: `entitlements_owners_in_edw`
* **Destination** (to compare/update): `entitlements_owners_in_graph`

Now, redefining:

---

### ‚úÖ **Definitions:**

1. **`delta_entitlement_owners`**:
   Entitlement owners in EDW have **changed** compared to those in Graph (i.e., any difference for a given `entitlementName` + `targetSystem` pair).

2. **`active_owners`**:
   Owners in Graph with status `Active`.

3. **`missing_owners_in_graph`**:
   Owners present in EDW but **missing** in Graph DB for that entitlement.

---

### üß† Key Logic:

For each `(entitlementName, targetSystem)`:

* Compare owners in **EDW (source)** vs **Graph (target)**
* Find deltas and missing owners accordingly

---

### üßæ Updated Code:

```python
import pandas as pd

# Example DataFrames
entitlements_owners_in_graph = pd.DataFrame({
    'entitlementName': ['Ent1', 'Ent2'],
    'targetSystem': ['SysA', 'SysB'],
    'owners': [['A1010', 'A1818'], ['B2020', 'B3030']],
    'owners_status': [[['A1010', 'Active'], ['A1818', 'Inactive']], [['B2020', 'Active'], ['B3030', 'Active']]]
})

entitlements_owners_in_edw = pd.DataFrame({
    'entitlementName': ['Ent1', 'Ent2'],
    'targetSystem': ['SysA', 'SysB'],
    'owner1': ['A1010', 'B2020'],
    'owner2': ['A1919', None],
    'owner3': [None, None]
})

# Helper to collect EDW owners
def get_edw_owners(row):
    return set(o for o in [row['owner1'], row['owner2'], row['owner3']] if pd.notna(o))

# Merge on key columns
merged = pd.merge(
    entitlements_owners_in_edw,
    entitlements_owners_in_graph,
    on=['entitlementName', 'targetSystem'],
    how='left'
)

def analyze_row(row):
    edw_owners = get_edw_owners(row)
    graph_owners = set(row['owners'] if isinstance(row['owners'], list) else [])

    # Delta if any owner changed between source and graph
    delta = edw_owners != graph_owners

    # Missing in graph
    missing = edw_owners - graph_owners

    # Active owners from graph
    active = []
    if isinstance(row['owners_status'], list):
        active = [emp for emp, status in row['owners_status'] if status.lower() == 'active']

    return pd.Series({
        'delta_entitlement_owners': delta,
        'missing_owners_in_graph': list(missing),
        'active_owners': active
    })

# Apply logic
results = merged.apply(analyze_row, axis=1)

# Combine and show
final = pd.concat([merged, results], axis=1)

print(final[['entitlementName', 'targetSystem', 'delta_entitlement_owners', 'missing_owners_in_graph', 'active_owners']])
```

---

### üîç Example Output:

| entitlementName | targetSystem | delta\_entitlement\_owners | missing\_owners\_in\_graph | active\_owners      |
| --------------- | ------------ | -------------------------- | -------------------------- | ------------------- |
| Ent1            | SysA         | True                       | \['A1919']                 | \['A1010']          |
| Ent2            | SysB         | False                      | \[]                        | \['B2020', 'B3030'] |

---

Let me know if you also want to generate a list of **owners to add** or **owners to remove** from the graph for syncing purposes.
