import logging

def update_data_to_identities(self, df, chunk_size=10000):
    """
    Update data in Glide identities table
    """
    try:
        cursor = self.glide_connection.cursor()
        cursor.execute("DESCRIBE glide.glideidentities;")
        table_columns = [column[0] for column in cursor.fetchall()]  # Fixed column index

        # Data Preparation
        df_new = df.copy()
        df_new.rename(columns={'EmployeeID': 'resourceid'}, inplace=True)
        df_columns = df_new.columns.tolist()
        req_columns = [col for col in df_columns if col in table_columns]

        set_clause = ', '.join([f"{col} = %s" for col in req_columns])
        update_query_template = f"UPDATE glide.glideidentities SET {set_clause} WHERE resourceid = %s"

        # Insert in chunks using executemany
        for start in range(0, len(df_new), chunk_size):
            end = start + chunk_size
            batch = df_new.iloc[start:end]
            resourceid_ids_in_batch = batch['resourceid'].tolist()

            # Check for missing resourceids values in the Glide database
            format_strings = ', '.join(['%s'] * len(resourceid_ids_in_batch))
            query = f"SELECT resourceid FROM glide.glideidentities WHERE resourceid IN ({format_strings})"
            
            cursor.execute(query, tuple(resourceid_ids_in_batch))
            existing_resource_ids = set(row[0] for row in cursor.fetchall())

            # Identify missing resourceids
            missing_resource_ids = [resource_id for resource_id in resourceid_ids_in_batch if resource_id not in existing_resource_ids]
            if missing_resource_ids:
                logging.info(f"Missing resourceid values from glide.glideidentities: {missing_resource_ids}")

            # Data Preparation for update
            batch_values = batch.values  # Convert the DataFrame chunk into a NumPy array
            data_to_update = []

            # Prepare arrays for faster operation
            req_columns_idx = [df_new.columns.get_loc(col) for col in req_columns]
            resourceid_idx = df_new.columns.get_loc('resourceid')

            for row in batch_values:
                row_data = [row[idx] for idx in req_columns_idx]
                resourceid_id = row[resourceid_idx]
                data_to_update.append(tuple(row_data + [resourceid_id]))

            # Prepare the update query
            update_query = update_query_template.format(set_clause=set_clause)

            # Use executemany to execute the query for the current batch
            try:
                cursor.executemany(update_query, data_to_update)
                self.glide_connection.commit()
                logging.info(f"Data updated in Glide identities table successfully for batch.")
            except Exception as e:
                logging.error(f"Error processing batch: {str(e)}")
                self.glide_connection.rollback()
                raise

        cursor.close()
        logging.info(f"Data updated in Glide identities table successfully for {len(df_new)} records.")
    
    except Exception as e:
        logging.error(f"Error fetching data: {str(e)} - Debug <Class: IAM DataExport | Method: update_data_to_identities()>")
        if self.glide_connection:
            self.glide_connection.rollback()
        raise
