// 1. Process input rows, derive flags
UNWIND $rows AS row
MATCH (u:User {employeeNumber: row.CVSResourceid})
WITH u, row,
     row.Aetnaldentifier_flag = 'y' AS isAetnaFlagged,
     row.is_conversion = 'Y' AND 'Conversion' IN labels(u) AS isConversion
WHERE isAetnaFlagged OR isConversion

// 2. Fetch available identifiers
WITH COLLECT(u) AS users, isAetnaFlagged, isConversion
MATCH (id:AetnaNetworkIdentifier:NetworkIdentifier)
WHERE NOT (id)--()
WITH users, COLLECT(id) AS identifiers, isAetnaFlagged, isConversion

// 3. Pair users with identifiers
UNWIND apoc.coll.zip(users, identifiers) AS pair
WITH pair[0] AS u, pair[1] AS id, isAetnaFlagged, isConversion,
     CASE 
        WHEN 'Employee' IN labels(u) THEN 'A'
        WHEN 'Contractor' IN labels(u) THEN 'N'
        ELSE 'DNE'
     END AS prefix

// 4. Assign network ID
SET id.networkid = prefix + id.uid

// 5. Conversion user logic
CALL apoc.do.when(
    isConversion,
    '
    OPTIONAL MATCH (u)-[r1:HAS_ATTRIBUTE]->(oldInfo:AetnaNetworkIdentifierInfo)
    OPTIONAL MATCH (oldInfo)-[r2:CURRENT]->(oldId:AetnaNetworkIdentifier)
    OPTIONAL MATCH (oldInfo)-[r3:HAS_AETNA_ID]->(oldId)

    WITH u, id, prefix, oldInfo, oldId, r1, r2, COLLECT(r3) AS oldLinks
    WHERE oldId IS NULL OR (prefix + id.uid) <> oldId.networkid

    CALL apoc.refactor.rename.type("HAS_AETNA_ID", "HAD_AETNA_ID", oldLinks) YIELD committedOperations

    CREATE (newInfo:AetnaNetworkIdentifierInfo {
        eventID: toString(u.employeeNumber) + prefix + id.uid + "." + toString(datetime()),
        date: datetime()
    })

    MERGE (u)-[:HAS_ATTRIBUTE]->(newInfo)
    MERGE (newInfo)-[newLink:HAS_AETNA_ID]->(id)
    SET 
        newLink.assigned_date = datetime(),
        newLink.assignedBy = "INT5043"

    MERGE (newInfo)-[:CURRENT]->(id)

    FOREACH (_ IN CASE WHEN oldInfo IS NOT NULL THEN [1] ELSE [] END |
        MERGE (newInfo)-[:PREVIOUS]->(oldInfo)
    )

    SET 
        u.legacyaetnaresourceid = u.aetnaresourceid,
        u.aetnaresourceid = prefix + id.uid,
        u.is_updated = "y"

    FOREACH (_ IN CASE WHEN u.cvsnetworkid IS NULL OR u.cvsnetworkid = oldId.networkid THEN [1] ELSE [] END |
        SET u.cvsnetworkid = prefix + id.uid
    )

    DELETE r1, r2
    REMOVE oldId.networkid

    RETURN count(*) AS updatedCount
    ',
    '',
    {u: u, id: id, prefix: prefix}
) YIELD value

// 6. Regular user logic
CALL apoc.do.when(
    isAetnaFlagged AND NOT isConversion,
    '
    CREATE (newInfo:AetnaNetworkIdentifierInfo {
        eventID: toString(u.employeeNumber) + prefix + id.uid + "." + toString(datetime()),
        date: datetime()
    })

    MERGE (u)-[:HAS_ATTRIBUTE]->(newInfo)
    MERGE (newInfo)-[r:HAS_AETNA_ID]->(id)
    SET 
        r.assigned_date = datetime(),
        r.assignedBy = "INT5043"

    MERGE (newInfo)-[:CURRENT]->(id)

    SET 
        u.aetnaresourceid = prefix + id.uid,
        u.is_updated = "y"

    FOREACH (_ IN CASE WHEN u.cvsnetworkid IS NULL THEN [1] ELSE [] END |
        SET u.cvsnetworkid = prefix + id.uid
    )

    RETURN count(*) AS updatedCount
    ',
    '',
    {u: u, id: id, prefix: prefix}
) YIELD value

RETURN count(*) AS total
