MATCH (u:User)
WHERE u.managerid IS NOT NULL

// Traverse the reporting structure (up to 4 levels)
OPTIONAL MATCH (u)-[:REPORTS_TO*1..4]->(m:User)
OPTIONAL MATCH (m)-[:HAS_ATTRIBUTE]->(n:Name)

WITH u, collect(distinct m) AS managers, collect(distinct n) AS names

UNWIND range(0, 3) AS level
WITH u, managers, names, level,
     CASE WHEN level < size(managers) THEN managers[level].employeeNumber ELSE NULL END AS managerid,
     CASE WHEN level < size(names) THEN names[level].givenName ELSE NULL END AS managerFirstName,
     CASE WHEN level < size(names) THEN names[level].familyName ELSE NULL END AS managerLastName

RETURN 
    u.employeeNumber AS employeeNumber,
    CASE 
        WHEN size(managers) = 1 AND u.employeeNumber = managers[0].employeeNumber THEN 1  
        WHEN size(managers) = 1 AND u.employeeNumber <> managers[0].employeeNumber THEN 2   
        WHEN size(managers) = 2 THEN 3   
        WHEN size(managers) = 3 THEN 4   
        ELSE 5                           
    END AS Level,
    managerid AS managerid,
    managerFirstName AS managerFirstName,
    managerLastName AS managerLastName
ORDER BY u.employeeNumber
