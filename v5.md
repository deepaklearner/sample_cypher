MATCH (ceo:User) 
WHERE ceo.employeeNumber = ceo.managerid  // Identify the CEO where employeeNumber matches managerid

// Traverse the reporting structure (up to 4 levels)
OPTIONAL MATCH (ceo)-[:REPORTS_TO*1..4]->(u:User)
OPTIONAL MATCH (u)-[:HAS_ATTRIBUTE]->(n:Name)
OPTIONAL MATCH (u)-[:REPORTS_TO]->(m:User)
OPTIONAL MATCH (m)-[:HAS_ATTRIBUTE]->(mName:Name)

WITH ceo, u, collect(distinct m) as managers, collect(distinct n) as names, collect(distinct mName) as managerNames

RETURN 
    u.employeeNumber AS employeeNumber, 
    managers[0].employeeNumber AS managerid, 
    CASE 
        WHEN size(managers) = 1 AND u.employeeNumber = managers[0].employeeNumber THEN 1  
        WHEN size(managers) = 1 AND u.employeeNumber <> managers[0].employeeNumber THEN 2   
        WHEN size(managers) = 2 THEN 3   
        WHEN size(managers) = 3 THEN 4   
        ELSE 5                           
    END AS Level,

    // Level 1 Manager details
    CASE WHEN size(managers) > 0 THEN managers[0].employeeNumber ELSE NULL END AS L1managerid,
    CASE WHEN size(managerNames) > 0 THEN managerNames[0].givenName ELSE NULL END AS L1managerFirstName,
    CASE WHEN size(managerNames) > 0 THEN managerNames[0].familyName ELSE NULL END AS L1managerLastName,

    // Level 2 Manager details
    CASE WHEN size(managers) > 1 THEN managers[1].employeeNumber ELSE NULL END AS L2managerid,
    CASE WHEN size(managerNames) > 1 THEN managerNames[1].givenName ELSE NULL END AS L2managerFirstName,
    CASE WHEN size(managerNames) > 1 THEN managerNames[1].familyName ELSE NULL END AS L2managerLastName,

    // Level 3 Manager details
    CASE WHEN size(managers) > 2 THEN managers[2].employeeNumber ELSE NULL END AS L3managerid,
    CASE WHEN size(managerNames) > 2 THEN managerNames[2].givenName ELSE NULL END AS L3managerFirstName,
    CASE WHEN size(managerNames) > 2 THEN managerNames[2].familyName ELSE NULL END AS L3managerLastName,

    // Level 4 Manager details
    CASE WHEN size(managers) > 3 THEN managers[3].employeeNumber ELSE NULL END AS L4managerid,
    CASE WHEN size(managerNames) > 3 THEN managerNames[3].givenName ELSE NULL END AS L4managerFirstName,
    CASE WHEN size(managerNames) > 3 THEN managerNames[3].familyName ELSE NULL END AS L4managerLastName

ORDER BY u.employeeNumber;
